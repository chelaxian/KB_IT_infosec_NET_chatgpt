# README — Включение маршрутизации и NAT (SNAT/маскарадинг) на Windows Server (RU)

Цель: сделать Windows Server L3-маршрутизатором и включить NAT так, чтобы трафик из внутренней сети (LAN),
уходящий наружу через “внешний” интерфейс (WAN), **натился в IP WAN-интерфейса** (SNAT/masquerade),
а обратный трафик корректно возвращался.

> Инструкция ориентирована на русскую локализацию Windows Server (2012 R2 / 2016 / 2019 / 2022 и т.п.).
> Работает как “с нуля”, так и если уже включён форвардинг.

---

## 0) Термины и схема

- **LAN (внутренний интерфейс)** — смотрит в сеть клиентов (частная сеть)
- **WAN (внешний интерфейс)** — смотрит в сторону аплинка/магистрали/Интернета/удалённой сети (публичная/внешняя)
- **Маршрутизация (IP forwarding)** — пересылка пакетов между интерфейсами
- **NAT (SNAT)** — подмена исходного адреса на адрес WAN-интерфейса, чтобы обратка вернулась на сервер

---

## 1) Предварительная подготовка (обязательно)

### 1.1 Определи интерфейсы
Открой PowerShell от администратора:

```powershell
Get-NetIPConfiguration
```

Зафиксируй:

* какой интерфейс = LAN
* какой интерфейс = WAN
* IP-адрес LAN интерфейса (он будет next-hop для клиентов)
* IP-адрес WAN интерфейса (в него будет NAT)

### 1.2 Проверь “шлюз по умолчанию”

Практика: **default gateway должен быть только на WAN-интерфейсе**.

Проверь:

```bat
route print
```

Если есть два шлюза по умолчанию (0.0.0.0/0) — это типовой источник проблем (асимметрия).

---

## 2) Установка роли RRAS (Маршрутизация и удалённый доступ)

1. **Диспетчер серверов**
2. **Управление** → **Добавить роли и компоненты**
3. **Установка ролей или компонентов** → Далее
4. **Роли сервера** → поставить галку **Удалённый доступ**
5. **Службы ролей** → поставить **Маршрутизация**
6. Установить (при необходимости перезагрузить сервер)

---

## 3) Включение маршрутизации и NAT через GUI (рекомендуется)

### 3.1 Запуск оснастки

**Диспетчер серверов** → **Средства** → **Маршрутизация и удалённый доступ**

### 3.2 Запуск мастера RRAS

1. В дереве слева: выбери свой сервер
2. ПКМ по имени сервера → **Настроить и включить маршрутизацию и удалённый доступ**
3. Выбери **Пользовательская конфигурация**
4. Отметь:

   * **Маршрутизация по локальной сети** (L3 forwarding)
   * **Преобразование сетевых адресов (NAT)** (SNAT)
5. Завершить мастер
6. Когда спросит — запусти службу (Start)

### 3.3 Назначение интерфейсов NAT (главный шаг)

1. В дереве слева: **IPv4** → **NAT**
2. ПКМ по **NAT** → **Новый интерфейс…**
3. Выбери **WAN-интерфейс**
4. В окне свойств:

   * выбрать **Общий интерфейс подключен к Интернету**
   * включить галку **Включить NAT на данном интерфейсе**
5. Повтори: **Новый интерфейс…**
6. Выбери **LAN-интерфейс**
7. Выбери **Частный интерфейс подключен к частной сети**

✅ Готово: теперь всё, что пойдёт с LAN наружу через WAN, будет **SNAT’иться в IP WAN**.

---

## 4) Если хочется без GUI — netsh (после установки RRAS)

Это работает **только когда RRAS/служба есть**, иначе команды могут быть “не найдены”.

### 4.1 Узнай точные имена интерфейсов

```bat
netsh interface show interface
```

### 4.2 Настрой NAT через netsh

> Заменяй `"ВНЕШНИЙ_ИНТЕРФЕЙС"` и `"ВНУТРЕННИЙ_ИНТЕРФЕЙС"` на имена из предыдущей команды.

```bat
netsh routing ip nat install

netsh routing ip nat add interface "ВНЕШНИЙ_ИНТЕРФЕЙС" full
netsh routing ip nat add interface "ВНУТРЕННИЙ_ИНТЕРФЕЙС" private

net start remoteaccess

netsh routing ip nat show interface
```

Смысл:

* `full` = внешний (public) интерфейс **с NAT**
* `private` = внутренний (LAN) интерфейс

---

## 5) Селективный NAT “только к одному адресу” (опционально)

Windows RRAS NAT обычно натит “всё, что уходит наружу”.
Чтобы NAT применялся **только к конкретному удалённому IP (например, 10.10.10.10)**,
нужно сделать так, чтобы через сервер ходил **только трафик к этому IP**.

### 5.1 Вариант “правильный” — маршрут /32 на L3-роутере/шлюзе LAN

Добавь маршрут на устройстве, которое является шлюзом для клиентов:

* `10.10.10.10/32 -> next-hop = LAN-IP Windows Server`

Так ты не трогаешь каждый хост.

### 5.2 Вариант “быстрый” — маршрут /32 на Windows-клиенте

На клиенте (CMD от админа):

```bat
route -p add 10.10.10.10 mask 255.255.255.255 <LAN_IP_WIN_SERVER>
```

Проверка (на клиенте):

```bat
tracert 10.10.10.10
```

Первый хоп должен быть Windows Server.

---

## 6) Проверки и диагностика

### 6.1 Проверка таблицы маршрутов

На сервере:

```bat
route print
```

### 6.2 Проверка, что пакеты реально идут через сервер

С клиента:

```bat
tracert <удаленный_IP>
```

### 6.3 Проверка NAT (косвенно)

* Запусти трафик с клиента (ping/port check/HTTP)
* В оснастке **Маршрутизация и удалённый доступ** смотри **IPv4 → NAT**
  (в зависимости от версии могут быть доступные просмотры сопоставлений/активности)

---

## 7) Частые грабли

1. **Два default gateway на сервере** → асимметрия, обратка может уходить не туда.
2. **WAN-IP недостижим для удалённой стороны** → даже при SNAT обратка не вернётся.
3. **Брандмауэр Windows / GPO** могут резать форвардинг/ICMP/службы RRAS.
4. Если нужно “Интернет для LAN” — NAT включать на WAN обязательно; одной маршрутизации недостаточно.

---

## 8) Быстрый чек-лист “с нуля”

* [ ] На сервере 2+ интерфейса: LAN и WAN
* [ ] Default gateway только на WAN
* [ ] Установлена роль: **Удалённый доступ → Маршрутизация**
* [ ] Включено RRAS: **Пользовательская конфигурация → Маршрутизация по локальной сети + NAT**
* [ ] В NAT:

  * [ ] WAN = “Общий интерфейс…”, галка “Включить NAT…”
  * [ ] LAN = “Частный интерфейс…”
* [ ] (Опционально) Настроен NAT через `netsh routing ip nat ...`
* [ ] Добавлены маршруты (если нужно селективно /32)
* [ ] `tracert` с клиента показывает первый хоп = Windows Server
* [ ] Удалённый хост отвечает, обратный трафик возвращается

---

## Приложение: полезные команды

Показать интерфейсы:

```bat
netsh interface show interface
```

Показать IP-конфигурацию:

```powershell
Get-NetIPConfiguration
```

Таблица маршрутов:

```bat
route print
```

Добавить маршрут /32 на Windows:

```bat
route -p add <IP> mask 255.255.255.255 <LAN_IP_WIN_SERVER>
```

```
::contentReference[oaicite:0]{index=0}
```
