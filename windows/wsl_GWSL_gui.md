Ниже приведена подробная пошаговая инструкция по настройке и запуску Linux‑приложений под WSL на Windows 11 с использованием GWSL.

---

## Шаг 1. Установка и настройка WSL

1. **Включение WSL (Windows Subsystem for Linux):**  
   - Откройте PowerShell от имени администратора и выполните команду:
     ```powershell
     wsl --install
     ```
   - Перезагрузите систему, если потребуется.  
   - Проверьте установленные дистрибутивы и их версии:
     ```bash
     wsl -l -v
     ```
   - Если дистрибутив не установлен, установите его из Microsoft Store (например, **Ubuntu**).

2. **Обновление Linux‑дистрибутива:**  
   - Запустите Ubuntu (или другой дистрибутив) и выполните:
     ```bash
     sudo apt update && sudo apt upgrade -y
     ```

---

## Шаг 2. Установка необходимых пакетов в Linux

1. **Установка X‑утилит и OpenGL (если приложение их требует):**  
   ```bash
   sudo apt install x11-apps mesa-utils libgl1-mesa-glx
   ```
   - Для проверки работы X‑сервера можно запустить, например:
     ```bash
     xeyes
     ```
     Если окно «глазок» появляется, значит базовая настройка X‑окружения работает.

2. **Дополнительные библиотеки (если приложение использует Qt):**  
   При необходимости можно установить Qt‑библиотеки:
   ```bash
   sudo apt install libqt5gui5 libqt5widgets5 libqt5core5a
   ```

---

## Шаг 3. Установка и настройка GWSL

1. **Установка GWSL:**  
   - Откройте Microsoft Store и найдите приложение **GWSL**.  
   - Нажмите «Установить». GWSL создаст на Windows собственный X‑сервер для подключения Linux‑приложений.

2. **Первичный запуск и настройка:**  
   - Запустите GWSL. Оно отобразит окно панели (Dashboard) с основными настройками.  
   - Проверьте и, при необходимости, отредактируйте конфигурационный файл. Пример итогового конфига:
     ```json
     {
       "conf_ver": 7,
       "gwsl_ver": "1.4.5",
       "general": {
         "pulseaudio": true,
         "hide_donation_reminder": false,
         "force_disable_primary": false,
         "clipboard": true,
         "start_menu_mode": true,
         "shell_gui": "wt",
         "acrylic_enabled": true
       },
       "graphics": {
         "window_mode": "multi",
         "hidpi": true
       },
       "putty": {
         "ip": null,
         "ssh_key": null
       },
       "distro_blacklist": [
         "docker"
       ],
       "app_blacklist": [
         "exampleblock"
       ],
       "xserver_profiles": {
         "Plain VcXsrv": [
           "-multiwindow",
           "-clipboard",
           "-wgl"
         ]
       }
     }
     ```
   - Если нужно, можно задать дополнительные параметры для X‑сервера (например, флаг `-ac` для отключения контроля доступа, но с пониманием рисков).

3. **Настройка брандмауэра и антивируса (Windows/Kaspersky):**  
   - Убедитесь, что GWSL (файлы `GWSL_vcxsrv.exe` и `pulseaudio.exe`) разрешены во входящих и исходящих правилах.  
   - При необходимости добавьте их в список доверенных приложений.

---

## Шаг 4. Настройка переменных окружения в WSL

1. **Настройка переменной DISPLAY:**  
   В WSL 2 IP‑адрес Windows‑хоста не всегда равен localhost. Задайте переменную на основе содержимого файла `/etc/resolv.conf`:
   ```bash
   export DISPLAY=$(grep nameserver /etc/resolv.conf | awk '{print $2}'):0.0
   ```
   - Проверьте значение:
     ```bash
     echo $DISPLAY
     ```

2. **Принудительное указание использования X11-плагина Qt:**  
   Если запускается приложение на Qt, задайте:
   ```bash
   export QT_QPA_PLATFORM=xcb
   export QT_X11_NO_MITSHM=1
   ```

3. **Если запускаете приложение от root:**  
   - Запустите команду с сохранением переменных окружения:
     ```bash
     sudo -E ./your_linux_app
     ```
   - Или заранее разрешите root-доступ к X-серверу:
     ```bash
     xhost +local:root
     ```

---

## Шаг 5. Тестовый запуск Linux‑приложения

1. **Проверьте работу X‑сервера:**  
   - Запустите тестовое приложение, например:
     ```bash
     xeyes
     ```
     Если окно появилось – настройка выполнена верно.

2. **Запуск вашего приложения:**  
   - Выполните:
     ```bash
     ./ug_ngfw_converter --help
     ```
     или замените на нужное вам приложение.

---

## Итоговая таблица шагов

| Шаг                                         | Команда/Действие                                                                                                                                                               | Описание                                                                                   |
|---------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------|
| **1. Установка WSL**                        | `wsl --install` (в PowerShell от администратора)                                                                                                                              | Включает WSL, устанавливает дистрибутив (например, Ubuntu)                                  |
| **2. Обновление Linux**                     | `sudo apt update && sudo apt upgrade -y`                                                                                                                                       | Обновляет пакеты дистрибутива                                                               |
| **3. Установка X‑утилит и OpenGL**           | `sudo apt install x11-apps mesa-utils libgl1-mesa-glx`                                                                                                                         | Устанавливает базовые инструменты для работы графических приложений                           |
| **4. Установка GWSL**                       | Установка из Microsoft Store (GWSL)                                                                                                                                            | GWSL предоставляет X‑сервер для Windows                                                    |
| **5. Первичная настройка GWSL**             | Запуск GWSL → Настройка через Dashboard → Редактирование конфига (если необходимо)                                                                                           | Настройка параметров: звук, буфер обмена, режим окон, HiDPI и пр.                             |
| **6. Настройка переменной DISPLAY**         | `export DISPLAY=$(grep nameserver /etc/resolv.conf | awk '{print $2}'):0.0`                                                                                                       | Задает IP Windows‑хоста вместо localhost                                                   |
| **7. Указание платформы Qt (если нужно)**   | `export QT_QPA_PLATFORM=xcb` <br> `export QT_X11_NO_MITSHM=1`                                                                                                                   | Принудительно использовать X11‑плагин Qt                                                   |
| **8. Тестовый запуск X‑приложения**           | `xeyes`                                                                                                                                                                        | Проверка работы X‑сервера                                                                   |
| **9. Запуск Linux‑приложения**              | `./ug_ngfw_converter --help` (или ваше приложение)                                                                                                                            | Запускает нужное Linux‑приложение с графическим интерфейсом                                  |

---

## Заключение

Эта инструкция охватывает все этапы от установки WSL до настройки GWSL и запуска Linux‑приложений под Windows 11. При выполнении шагов:

- **Проверьте, что X‑сервер (GWSL) запущен** и правильно настроен.
- **Установите корректное значение переменной DISPLAY** (на основе IP‑адреса Windows‑хоста).
- **При необходимости настройте Qt-переменные**, чтобы приложение корректно использовало X11‑плагин.
- **Если возникают ошибки**, проверьте логи и убедитесь, что все зависимости (библиотеки) установлены в Linux‑среде.
